#!/usr/bin/env python3

import os
import sys
from fcntl import ioctl
from termios import TIOCSCTTY
from argparse import ArgumentParser, REMAINDER


def go(urxvt_args, cmd, fds):
    master, slave = os.openpty()
    os.set_inheritable(master, True)
    os.set_inheritable(slave, True)
    if os.fork():
        os.close(slave)
        os.execvp('urxvt', ['urxvt', '-pty-fd', str(master)] + urxvt_args)
    else:
        os.setsid()
        ioctl(slave, TIOCSCTTY)
        for fd in fds:
            os.dup2(slave, fd)
        os.execvp('sh', ['sh', '-c', cmd])


def main():

    fdnames = ['in', 'out', 'err']

    parser = ArgumentParser(description='Run a command with a new urxvt instance as its controlling terminal')
    parser.add_argument('cmd', metavar='CMD', help='Command to run')
    parser.add_argument('urxvt_args', metavar='URXVT_ARGS', nargs=REMAINDER, help='Extra urxvt arguments')

    for fdname in fdnames:
        parser.add_argument(
                '-' + fdname[0],
                '--' + fdname,
                action='store_true',
                help='New process inherits slave pty as std{}'.format(fdname),
                )

    args = parser.parse_args()

    fds = []
    for fd, fdname in enumerate(fdnames):
        if getattr(args, fdname):
            fds.append(fd)

    go(args.urxvt_args, args.cmd, fds)


if __name__ == '__main__':
    main()
